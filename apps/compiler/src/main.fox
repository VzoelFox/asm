; ============================================================================
; Morph Self-Hosted Compiler - Main Entry Point
; ============================================================================
;
; Version: 0.3.0 (Modular ID-Based)
; Updated: 2026-01-05
;
; CHANGELOG:
; - 2026-01-05: Refactored to use ID-based imports (Ambil) instead of file
;               imports (ambil) to solve bootstrap compiler 150-line limit
;               and recursive import infinite loop issues.
;               Engineering: Kiro (AWS Q CLI Agent)
;               Reference: docs/MODULAR_ARCHITECTURE.md, docs/COMPILATION_STRATEGY.md
;               Original architecture by: Claude Code (Anthropic)
;
; - 2026-01-04: Initial modular refactoring by Claude Code
;
; ARCHITECTURE:
; This file is the single entry point for the self-hosted compiler.
; All modules are imported via ID-based system (Ambil) which extracts
; specific code blocks marked with ### <id> from source files.
;
; Key insight: "The foundation determines everything. Build AST first,
; rest follows naturally." - Vzoel Fox, 2026-01-04
;
; For archived versions, see: apps/compiler/src/archive/
; ============================================================================

### 1000
; Morph Self-Hosted Compiler Entry Point (Refactored)
; NOTE: Uses ID-based imports to avoid recursive file parsing

; === LOAD ID REGISTRY ===
indeks "indeks.fox"

; === STANDARD LIBRARY ===
Ambil 310, 311, 312, 313, 314, 315, 316 ; Buffer
Ambil 318, 319 ; File IO
Ambil 320, 321, 322, 323, 324 ; Format
Ambil 330, 331, 332, 333 ; Hashmap
Ambil 340, 341, 342, 343, 344 ; Vector
Ambil 380, 381, 382, 383, 384, 385, 386, 387, 388 ; String Utils
Ambil 390, 391 ; str_to_int, str_index_of

; === COMPILER CORE MODULES ===
Ambil 1010, 1011 ; globals
Ambil 1020, 1021 ; constants
Ambil 1030 ; codegen
Ambil 1040, 1041, 1042, 1043, 1044, 1045, 1046, 1047 ; types
Ambil 1050, 1051, 1052, 1053, 1054, 1055, 1056 ; supplier

; === PARSER HELPERS ===
Ambil 1100, 1101, 1102, 1103 ; parser_helpers_import
Ambil 1110, 1111, 1112 ; parser_helpers_struct
Ambil 1120, 1121 ; parser_helpers_fungsi
Ambil 1122, 1123, 1124, 1125 ; parser_helpers_jika
Ambil 1126, 1127 ; parser_helpers_loop
Ambil 1130, 1131, 1132, 1133, 1134, 1135, 1136, 1137, 1138, 1139 ; parser_helpers_stmt

; === PARSER DISPATCHERS ===
Ambil 1140 ; parser_dispatch_import
Ambil 1141 ; parser_dispatch_struct
Ambil 1142 ; parser_dispatch_control
Ambil 1143 ; parser_dispatch_var_struct
Ambil 1144 ; parser_dispatch_var_simple
Ambil 1145 ; parser_dispatch_cetak
Ambil 1146 ; parser_dispatch_panggil

fungsi mulai(arg_unused1, arg_unused2)
  ; === INITIALIZATION ===
  panggil init_globals()
  panggil init_constants()
  panggil init_type_system()
  panggil init_supplier_system()

  ; === READ INPUT FILE ===
  var args_count = global_argc
  var args_ptr = global_argv

  jika (args_count < 2)
     cetak("Penggunaan: ./morph <file.fox>")
     asm_mulai
     mov rax, 60
     mov rdi, 1
     syscall
     tutup_asm
  tutup_jika

  var filename_ptr = 0
  asm_mulai
  mov rbx, [var_args_ptr]
  mov rax, [rbx + 8]
  mov [var_filename_ptr], rax
  tutup_asm

  cetak("Morph Self-Hosted Compiler v0.2 (Modular)")
  cetak("Compiling:")
  cetak_str(filename_ptr)

  var buf = buffer_dari_file(filename_ptr)
  jika (buf == 0)
     cetak("Fatal: Gagal membaca file input.")
     asm_mulai
     mov rax, 60
     mov rdi, 1
     syscall
     tutup_asm
  tutup_jika

  tipe buf MemoryBuffer
  var content = buf.data_ptr
  var lines = vec_create(100)
  panggil str_split_lines(content, lines)

  var line_count = vec_len(lines)
  cetak("Lines parsed:")
  cetak(line_count)

  ; === GENERATE ENTRY POINT ===
  panggil emit("section .text")
  panggil emit("    global _start")
  panggil emit("_start:")
  panggil emit("    call mulai")

  var asm_exit_1 = "    mov rax, 60"
  panggil emit(asm_exit_1)

  var asm_exit_2 = "    xor rdi, rdi"
  panggil emit(asm_exit_2)

  panggil emit("    syscall")

  ; === PARSE SOURCE CODE ===
  panggil parse_source_lines(lines)

  ; === GENERATE BSS SECTION ===
  panggil emit("section .bss")
  var vars_vec_2 = global_vars
  var vars_len = vec_len(vars_vec_2)
  var v_idx = 0

  var s_v_pref = "var_"

  selama (v_idx < vars_len)
     var v_name = vec_get(vars_vec_2, v_idx)
     var v_decl = str_concat(s_v_pref, v_name)
     var s_resq = ": resq 1"
     v_decl = str_concat(v_decl, s_resq)
     panggil emit(v_decl)
     v_idx = v_idx + 1
  tutup_selama

  ; === WRITE OUTPUT FILE ===
  var out_file = "output.asm"
  cetak("Writing output to:")
  cetak_str(out_file)

  var out_len = vec_len(output_lines)
  var k = 0
  var newline_str = str_newline()
  var nl_len = 1
  var write_fd = 0
  var flags = 577
  var mode = 420

  asm_mulai
  mov rsi, [var_out_file]
  mov rdx, [var_flags]
  mov rax, 2
  mov rdi, rsi
  mov rsi, rdx
  mov rdx, [var_mode]
  syscall
  mov [var_write_fd], rax
  tutup_asm

  jika (write_fd < 0)
     cetak("Error opening output.asm")
  lain
     selama (k < out_len)
        var line_content = vec_get(output_lines, k)
        var l_len = str_len(line_content)
        asm_mulai
        mov rdi, [var_write_fd]
        mov rsi, [var_line_content]
        mov rdx, [var_l_len]
        call sys_write_fd
        tutup_asm
        asm_mulai
        mov rdi, [var_write_fd]
        mov rsi, [var_newline_str]
        mov rdx, [var_nl_len]
        call sys_write_fd
        tutup_asm
        k = k + 1
     tutup_selama
     asm_mulai
     mov rdi, [var_write_fd]
     call sys_close
     tutup_asm

     ; Check for type errors before declaring success
     panggil report_type_errors()

     cetak("Success!")
  tutup_jika
tutup_fungsi
